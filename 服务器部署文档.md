
服务器部署指南（阿里云私有仓库 + 宝塔反代）

一、总体说明

- 客户端采用 docker compose 一键部署，使用预先构建并推送到阿里云私有仓库的镜像。
- 运行端口：8000（WebSocket/设备）、8002（管理后台 Web）、8003（HTTP/视觉/OTA）。
- 配置采用 data/.config.yaml（优先于 config.yaml），compose 已将宿主机 ./data 挂载到容器内。

二、开发/构建端：本地构建并推送镜像

1) 登录阿里云镜像仓库

```
docker login registry.cn-hangzhou.aliyuncs.com
```

2) 构建并推送三件套镜像（建议直接指定你的私有仓库 tag）

示例：
```
./docker-build-all.sh && docker push registry.cn-hangzhou.aliyuncs.com/ruapper/zj-api:latest &&  docker push registry.cn-hangzhou.aliyuncs.com/ruapper/zj-server:latest && docker push registry.cn-hangzhou.aliyuncs.com/ruapper/zj-web-react:latest
```

说明：
- 脚本会顺序构建 manager-api、server、manager-web-react 三张镜像，并在末尾执行 push。
- 也可在一个 `.env` 中定义 `MANAGER_API_IMAGE_TAG`、`SERVER_IMAGE_TAG`、`WEB_REACT_IMAGE_TAG`，然后直接运行 `./docker-build-all.sh`。

三、客户机（宝塔服务器）部署（无需在客户机拉代码）

本章提供两种方式：

A) 一键脚本（全自动，脚本会使用固定目录 /opt/xiaozhi-server）

1) 执行安装脚本（需 root）：
```
bash docker-setup.sh
```
- 脚本会安装 Docker/Compose、创建目录、下载模型和默认 compose 文件，并启动服务；所有文件放在 `/opt/xiaozhi-server` 下。

2) 切换到你的私有镜像（两种方式，二选一）

方式 A1（推荐）：在 `/opt/xiaozhi-server/.env` 填写三项，compose 会自动读取：
```
SERVER_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/<repo-server>:<tag>
MANAGER_API_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/<repo-api>:<tag>
WEB_REACT_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/<repo-web>:<tag>
```
然后执行：
```
docker login registry.cn-hangzhou.aliyuncs.com
docker compose -f /opt/xiaozhi-server/docker-compose_all.yml pull
docker compose -f /opt/xiaozhi-server/docker-compose_all.yml up -d
```

方式 A2：直接编辑 `/opt/xiaozhi-server/docker-compose_all.yml` 的 `image` 字段为你的私有镜像，然后：
```
docker compose -f /opt/xiaozhi-server/docker-compose_all.yml up -d
```

3) 管理端密钥配置（server.secret）

首次启动后，访问管理后台注册管理员账号，进入“参数字典 → 参数管理”找到 `server.secret`。将其写入 `/opt/xiaozhi-server/data/.config.yaml`：

```
manager-api:
  url: http://zj-manager-api:8002/xiaozhi
  secret: <从管理端复制的server.secret值>
```

说明：容器间互访建议使用服务名 `zj-manager-api:8002`。

B) 纯 docker compose（自定义目录，不使用脚本）

设定你的部署目录（示例）：
```
export DEPLOY_DIR=/srv/xiaozhi-server
mkdir -p $DEPLOY_DIR/data $DEPLOY_DIR/models/SenseVoiceSmall
```

1) 准备 docker-compose 文件与 .env

将官方 compose 下载到你的目录（或使用你维护的副本）：
```
curl -fL -o $DEPLOY_DIR/docker-compose_all.yml \
  https://raw.githubusercontent.com/xinnan-tech/xiaozhi-esp32-server/refs/heads/main/main/xiaozhi-server/docker-compose_all.yml
```

创建 `$DEPLOY_DIR/.env`，覆盖镜像为你的阿里云私有仓库：
```
cat > $DEPLOY_DIR/.env <<'EOF'
SERVER_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/<repo-server>:<tag>
MANAGER_API_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/<repo-api>:<tag>
WEB_REACT_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/<repo-web>:<tag>
TZ=Asia/Shanghai
SERVER_WS_PORT=8000
SERVER_HTTP_PORT=8003
WEB_PORT=8002
EOF
```

2) 准备覆盖配置与模型占位

创建最小化配置文件（后续再在管理端填入密钥）：
```
cat > $DEPLOY_DIR/data/.config.yaml <<'EOF'
manager-api:
  url: http://zj-manager-api:8002/xiaozhi
  secret: ''
EOF
```

模型文件（如使用默认 FunASR 本地模型），可后续再下载到：
`$DEPLOY_DIR/models/SenseVoiceSmall/model.pt`

3) 启动（在部署目录执行）
```
cd $DEPLOY_DIR
docker login registry.cn-hangzhou.aliyuncs.com
docker compose -f docker-compose_all.yml pull
docker compose -f docker-compose_all.yml up -d
```

4) 填写 server.secret

访问管理后台，复制 `server.secret` 后写入 `$DEPLOY_DIR/data/.config.yaml` 并重启 server 容器：
```
docker compose -f $DEPLOY_DIR/docker-compose_all.yml restart zj-server
```

四、宝塔（BT）Nginx 反向代理

- 前端（管理后台 Web）：反代到宿主机 `127.0.0.1:8002`
- WebSocket（设备 WS）：反代到 `127.0.0.1:8000`，并添加：
  ```
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 3600;
  ```
- 视觉/HTTP 接口（OTA/视觉识别等）：反代到 `127.0.0.1:8003`

注意：宝塔 Nginx 在宿主机上，无法解析容器服务名；对外反代需指向宿主机端口。

五、配置与数据持久化

- 配置优先读取 `/opt/xiaozhi-server/data/.config.yaml`，若键不存在再回落到 `config.yaml`。
- compose 已将宿主机 `./data` 挂载到容器 `/opt/xiaozhi-esp32-server/data`，修改宿主机配置即可生效。
- 模型文件需要存在：`/opt/xiaozhi-server/models/SenseVoiceSmall/model.pt`（脚本会自动下载）。

六、常见问题排查

- 无法拉取镜像：确认 `docker login registry.cn-hangzhou.aliyuncs.com` 成功，镜像名与 tag 正确。
- 服务不健康：`docker ps` 查看容器状态；`docker logs <容器名>` 查看日志；检查 8000/8002/8003 端口放行。
- 管理端访问 404：确认 web-react 容器已启动，且宝塔反代指向 `127.0.0.1:8002`。
- 设备 WS 连接失败：确认宝塔 WS 反代已添加 Upgrade/Connection 头，并指向 `127.0.0.1:8000`。

七、ASCII 流程图

```
开发/构建机
  └─ docker-build-all.sh
         │
         ▼
     构建本地镜像(api/server/web)
         │
         ▼
   docker login 阿里云
         │
         ▼
   docker push 到私有仓库
         │
         ▼
客户服务器（宝塔）
  ├─ A: 运行 docker-setup.sh（自动使用 /opt/xiaozhi-server）
  │       └─ 写 .env 覆盖镜像 → compose pull/up
  └─ B: 纯 compose（自定义目录 $DEPLOY_DIR）
          └─ 下载 compose/.env → compose pull/up
         │
         ▼
   写 /opt/xiaozhi-server/.env 指向私有镜像
         │
         ▼
   docker compose pull && up -d
         │
         ▼
 服务运行：8000(ws)/8002(web)/8003(http)
         │
         ▼
宝塔 Nginx
  ├─ 域名 → 127.0.0.1:8002 (web)
  ├─ WS  → 127.0.0.1:8000 (+升级头)
  └─ HTTP→ 127.0.0.1:8003
```
