# 服务器部署指南（2025-09 更新）

本文面向已经拥有阿里云私有镜像仓库、计划在 CentOS/RHEL 系列服务器上部署整套 **xiaozhi-esp32** 服务的同学。内容覆盖镜像构建、镜像推送、一键部署脚本的用法以及常见排错。

> 约定：仓库根目录为 `/path/to/xiaozhi-esp32-server`，如无特殊说明均在该目录执行命令。

---

## 1. 组件与端口概览

| 模块            | 容器名称          | 默认对外端口 | 说明 |
|-----------------|-------------------|--------------|------|
| manager-api     | `zj-manager-api`  | 8002         | Spring Boot 后台，Tomcat context-path `/xiaozhi` |
| manager-web     | `zj-manager-web-react` | 8001 (容器内部 80) | React + Nginx，前端请求 `/api/*` 反代到 manager-api |
| server          | `zj-server`       | 8000 (WS) / 8003 (HTTP) | 设备侧 WebSocket/视觉接口 |
| MySQL/Redis     | `zj-server-db` / `zj-server-redis` | 3306 / 6379 | 可改为外部服务 |

### 数据与配置挂载

部署脚本默认使用 `/opt/zj-server` 作为宿主目录：

```
/opt/zj-server/
  ├─ data/              # data/.config.yaml 等覆盖配置
  ├─ models/            # ASR 等模型文件
  ├─ mysql/             # MySQL 数据目录（使用内置 MySQL 时）
  ├─ uploadfile/        # manager-api 上传目录
  └─ docker-compose_all.yml
```

`manager-api` 必须在 `data/.config.yaml` 中配置 `server.secret` 才能正常工作（首次启动后到后台参数字典复制即可）。

---

## 2. 镜像构建与推送

构建脚本统一位于仓库根目录，支持 `.env` 自动加载，也可以传 `--env-file`。

1. **登录阿里云镜像仓库**
   ```bash
   docker login registry.cn-hangzhou.aliyuncs.com
   ```

2. **设置镜像标签（可在 `.env` 或单独的 env 文件中定义）**
   ```env
   MANAGER_API_IMAGE_TAG=registry.cn-hangzhou.aliyuncs.com/<ns>/zj-api:latest
   SERVER_IMAGE_TAG=registry.cn-hangzhou.aliyuncs.com/<ns>/zj-server:latest
   WEB_REACT_IMAGE_TAG=registry.cn-hangzhou.aliyuncs.com/<ns>/zj-web-react:latest
   DOCKER_MIRROR=aliyun    # 可选：加速基础镜像拉取
   DOCKER_PLATFORM=linux/amd64  # 若需跨架构构建
   ```

3. **一键构建并推送**
   ```bash
   ./docker-build-all.sh --env-file .env
   ```
   脚本会依次调用：
   - `docker-build-manager-api.sh`
   - `docker-build-server.sh`
   - `docker-build-web-react.sh`
   并自动下载缺失的 SenseVoiceSmall 模型、封装静态前端、最后执行 `docker push`。

   > 若只想构建不推送，可先运行 `./docker-build-all.sh --skip-web-build`，在脚本末尾手动注释掉 push 部分或自定义标签。

4. **单独构建某个镜像**（可选）：
   ```bash
   ./docker-build-manager-api.sh --tag registry.cn-hangzhou.aliyuncs.com/<ns>/zj-api:dev \
     --db-host 127.0.0.1 --db-port 3306 --db-name xiaozhi_esp32_server

   ./docker-build-server.sh --tag registry.cn-hangzhou.aliyuncs.com/<ns>/zj-server:test

   ./docker-build-web-react.sh --tag registry.cn-hangzhou.aliyuncs.com/<ns>/zj-web-react:test \
     --api-base /api
   ```

---

## 3. 服务器一键部署脚本（CentOS/RHEL x86_64）

脚本：`docker-setup-zj-centos.sh`

### 3.1 前置条件
- 服务器需为 CentOS/RHEL/AlmaLinux/Rocky (x86_64)，具备 root 权限。
- 已能访问阿里云镜像仓库（确保 `docker login` 可通过）。
- 把以下文件上传到服务器同一目录（建议 `/www` 或 `/root`）：
  - `docker-setup-zj-centos.sh`
  - `main/xiaozhi-server/docker-compose_all.yml`
  - （可选）自定义配置文件，例如 `config_from_api.yaml`

### 3.2 执行脚本
```bash
chmod +x docker-setup-zj-centos.sh
sudo ./docker-setup-zj-centos.sh
```

脚本流程概要：
1. 检查/安装 `curl`、`Docker`、`docker compose`，并提示选择镜像加速源。
2. 默认安装目录 `/opt/zj-server`，自动创建 `data/`、`models/` 等目录。
3. 若首次执行，可选择下载最新 `config_from_api.yaml`；如果检测到已有部署，会询问是否进行镜像升级（拉取最新镜像、重新 `up -d`）。
4. 运行 `docker compose -f <脚本同目录>/docker-compose_all.yml up -d`，并根据健康检查确认启动成功。
5. 引导填写 `server.secret`：脚本会提示管理员登录后台后复制值写入 `/opt/zj-server/data/.config.yaml`。

### 3.3 常用修改项
- **镜像标签**：修改脚本同目录下的 `docker-compose_all.yml` 中 `image:` 配置即可。
- **数据库/Redis**：
  - 使用内置 MySQL/Redis 时可保留默认环境变量；
  - 若连接外部服务，修改 `SPRING_DATASOURCE_DRUID_URL`、`SPRING_DATA_REDIS_HOST` 等环境变量（支持 `.env` 覆盖）。
- **前端反向代理**：`main/manager-web-react/nginx.conf` 会在镜像内生效，如需临时调整，可通过挂载覆盖：
  ```yaml
  zj-manager-web-react:
    volumes:
      - ./nginx.webreact.conf:/etc/nginx/conf.d/default.conf:ro
  ```

### 3.4 升级 / 回滚
- 再次执行脚本会进入“升级流程”，自动拉取最新镜像并重新 `up -d`。
- 或者手动执行：
  ```bash
  cd /opt/zj-server
  docker compose -f docker-compose_all.yml pull
  docker compose -f docker-compose_all.yml up -d
  ```
- 回滚：拉取旧标签后再次 `up -d` 即可。

---

## 4. 手工部署（无需脚本）

若需要自定义目录或运行在非 CentOS 环境，可手动执行：

1. **准备目录与文件**
   ```bash
   export DEPLOY_DIR=/srv/zj-server
   mkdir -p \ 
     $DEPLOY_DIR/{data,models/SenseVoiceSmall,uploadfile,mysql}
   cp main/xiaozhi-server/docker-compose_all.yml $DEPLOY_DIR/
   cp main/xiaozhi-server/config_from_api.yaml $DEPLOY_DIR/data/.config.yaml  # 可选
   ```

2. **填写 `.env`**（覆盖镜像与端口）：
   ```bash
   cat > $DEPLOY_DIR/.env <<'EOF'
   SERVER_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/zj-server:latest
   MANAGER_API_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/zj-api:latest
   WEB_REACT_IMAGE=registry.cn-hangzhou.aliyuncs.com/<ns>/zj-web-react:latest
   TZ=Asia/Shanghai
   WEB_PORT=8002
   SERVER_WS_PORT=8000
   SERVER_HTTP_PORT=8003
   EOF
   ```

3. **启动**
   ```bash
   cd $DEPLOY_DIR
   docker login registry.cn-hangzhou.aliyuncs.com
   docker compose -f docker-compose_all.yml pull
   docker compose -f docker-compose_all.yml up -d
   ```

4. **配置 `server.secret`**
   - 登录后台 `http://<host>:8002/`
   - 参数字典 → `server.secret`
   - 写入 `$DEPLOY_DIR/data/.config.yaml`，重启 `zj-server` 容器。

---

## 5. 宝塔（BT）反向代理建议

| 访问域名 | 目标地址 | 备注 |
|----------|----------|------|
| 管理后台 Web | `127.0.0.1:8002` | 静态 + API |
| 设备 WebSocket | `127.0.0.1:8000` | 需额外 Header：
  ```
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 3600;
  ``` |
| 视觉/HTTP 接口 | `127.0.0.1:8003` | 可根据实际路径配置 |

> 宝塔位于宿主机网络，无法解析容器内服务名，必须使用宿主机端口。

---

## 6. 常用排错

| 场景 | 检查点 |
|------|---------|
| `docker compose up` 后容器 unhealthy | `docker ps`、`docker logs <容器名>` 查看具体日志；确认 MySQL/Redis 是否可达；检查 `SPRING_DATASOURCE_DRUID_URL` 与 `SPRING_DATA_REDIS_HOST` 是否写对。 |
| 前端访问 502/返回 index.html | 确认 `zj-manager-api` 是否正常启动；`docker exec zj-manager-web-react curl -I http://zj-manager-api:8002/xiaozhi/`；检查 Nginx `/api/` 反代配置；确保前端构建时 `VITE_API_BASE_URL=/api`。 |
| 设备 WebSocket 连接失败 | 查看宝塔反代是否添加了 Upgrade/Connection；确认 8000 端口对外放行。 |
| 新镜像不生效 | `docker compose pull` 之后可用 `docker inspect <image> --format '{{.RepoDigests}}'` 验证摘要；必要时 `docker compose down && up -d`。 |
| `docker-setup-zj-centos.sh` 安装失败 | 确认服务器是 CentOS/RHEL 家族并有外网；若 curl/Docker 安装失败，可手动安装后重新运行脚本。 |

---

## 7. 附录：脚本参数速查

### docker-build-manager-api.sh
- `--tag` 目标镜像，例如 `registry.../zj-api:latest`
- `--db-host/--db-port/--db-name/--db-user/--db-pass` 用于 `--run` 调试时的默认数据库连接
- `--mirror` 指定基础镜像加速源（daocloud、aliyun、tencent…）
- `--platform` 构建平台（如 `linux/amd64`）
- `--run` 构建后立即 `docker run` 调试

### docker-build-server.sh
- 同样支持 `--mirror`、`--platform`
- 自动校验并下载 SenseVoiceSmall 模型
- `--ws-port` / `--http-port` 仅在 `--run` 调试模式下生效

### docker-build-web-react.sh
- `--api-base` 设置生产环境 `VITE_API_BASE_URL`
- `--skip-build` 使用已有 `www/` 静态文件（调试时可节省时间）

### docker-build-all.sh
- `--mirror`、`--platform` 会传递给子脚本
- `--web-api-base` 等价于调用 web 脚本的 `--api-base`
- 自动在最后 push 三个镜像，可按需修改

---

如遇未覆盖的问题，建议：
1. `docker logs <container>` 定位报错；
2. 检查 `docker-compose_all.yml` 与 `.env` 的变量是否匹配；
3. 在仓库 issue 或内部群反馈，附上日志与配置。
