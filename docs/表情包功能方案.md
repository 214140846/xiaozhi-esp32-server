# 表情包下放功能方案

## 背景与目标
- 目前设备端仅能通过内置映射在对话中展示 Emoji，无法承载品牌化表情或动图素材。
- 运营与用户希望在角色配置页自定义表情，并下发到指定设备，实现更加丰富的情绪反馈。
- 本方案旨在提供默认表情包的统一管理、角色级自定义上传、设备下发与同步的整体实现路径。

## 需求梳理
- **默认表情包**：后端维护一套出厂默认表情包，在设备首次同步或角色未自定义时使用，需包含表情编码、Emoji、静态资源 URL、文件大小等信息。
- **角色自定义**：在智控台角色配置页新增表情管理面板，用户可按表情类型上传图片/动图（PNG/WebP/GIF，建议尺寸不超过 512×512，单个 < 300 KB）。
- **版本化下发**：角色表情配置需要生成版本号；当用户保存后，可选择立即下发给关联设备，设备端根据版本号增量同步。
- **文件存储**：沿用 manager-api 的文件上传能力，统一存储在 `uploadfile/emotions/` 目录下，并支持挂载到对象存储/CDN。
- **兼容 Emoji 回退**：若某个表情未配置图片，设备保持 Emoji 展示能力，确保对话流程不受影响。

## 默认表情定义
| code | emoji | 说明 |
| --- | --- | --- |
| neutral | 😶 | 平静 |
| happy | 🙂 | 开心 |
| laughing | 😆 | 大笑 |
| funny | 😂 | 搞笑 |
| sad | 😔 | 伤心 |
| angry | 😠 | 生气 |
| crying | 😭 | 哭泣 |
| loving | 😍 | 热爱 |
| embarrassed | 😳 | 害羞 |
| surprised | 😯 | 惊讶 |
| shocked | 😱 | 震惊 |
| thinking | 🤔 | 思考 |
| winking | 😉 | 眨眼 |
| cool | 😎 | 酷 |
| relaxed | 😌 | 放松 |
| delicious | 😋 | 美味 |
| kissy | 😘 | 飞吻 |
| confident | 😏 | 自信 |
| sleepy | 😴 | 困倦 |
| silly | 😜 | 调皮 |
| confused | 🙄 | 无语 |

> 以上列表与现有 `DeviceEmotion` default 常量保持一致，后端以数据库种子或配置文件的方式初始化。

## 总体架构
```
前端（manager-web-react）
   │  上传/编辑表情 + 提交配置
   ▼
Manager API（Java）
   │  识别默认/自定义、写库、生成版本
   ▼
静态资源存储（uploadfile / OSS / CDN）
   │  提供设备可访问的 URL
   ▼
xiaozhi-server（Python）
   │  读取角色表情配置，组合成 manifest
   ▼
设备（ESP32）
   │  比对版本 → 下载缺失资源 → 缓存 → 展示
```

## 数据模型设计
### 表：`emotion_library`
- `id` (PK, UUID)
- `code` (varchar, 唯一) —— 与设备协议一致
- `emoji` (varchar)
- `display_name` (varchar)
- `file_url` (varchar, 允许为空)
- `file_type` (enum: png/webp/gif)
- `file_size` (int, Byte)
- `is_default` (tinyint, 0/1)
- `status` (tinyint, 0=停用,1=启用)
- `created_at` / `updated_at`

### 表：`agent_emotion_pack`
- `id` (PK, UUID)
- `agent_id` (varchar, FK `ai_agent.id`)
- `version` (int, 自增)
- `status` (enum: draft/published)
- `device_target` (json，可选：绑定的设备列表或分组)
- `created_at` / `updated_at`

### 表：`agent_emotion_asset`
- `id` (PK, UUID)
- `pack_id` (FK `agent_emotion_pack.id`)
- `code` (varchar)
- `emoji` (varchar)
- `file_url` (varchar)
- `file_size` (int)
- `file_type` (enum)
- `width` / `height` (int，可选)
- `frame_count` (int，可选，Gif/WebP 用)
- `checksum` (varchar, md5/sha256, 用于设备增量校验)
- `created_at` / `updated_at`

> 默认表情包以 `is_default=1` 存放在 `emotion_library`，若用户未上传自定义图，系统下发时优先合并默认资源。

## 后端改造要点（Manager API）
- **表结构初始化**：新增 MyBatis-Plus 实体、Mapper、Liquibase changelog，导入默认表情记录。
- **上传 API**：沿用 `OTAMagController` 中的上传逻辑，新增 `EmotionController`:
  - `POST /api/v1/emotions/library/upload`：返回文件 URL、尺寸、文件类型。
  - `POST /api/v1/emotions/packs/{agentId}`：保存或更新角色表情配置（草稿）。
  - `GET /api/v1/emotions/packs/{agentId}`：查询当前草稿+已发布版本。
  - `POST /api/v1/emotions/packs/{agentId}/publish`：生成新版本号，写入 `agent_emotion_pack`，触发下发任务。
- **版本策略**：publish 时将 `version = max(version)+1`；保存草稿仅更新 `agent_emotion_asset` 与 `status=draft`。
- **任务触发**：调用 existing 设备任务调度接口（若无，可新增 `DeviceTaskService`），将 `agentId + packVersion` 推送至 `xiaozhi-server`。

## xiaozhi-server 改造
- **配置同步接口**：新增 REST endpoint `GET /internal/device/{deviceId}/emotion-pack`，或重用现有设备配置拉取接口，返回：
  ```json
  {
    "agentId": "...",
    "version": 3,
    "manifestUrl": "https://cdn/.../agent/{agentId}/manifest-v3.json"
  }
  ```
- **Manifest 生成**：在 publish 时由 Manager API 生成并写入 `uploadfile/emotions/{agentId}/manifest-v{version}.json`，内容示例：
  ```json
  {
    "agentId": "AGT001",
    "version": 3,
    "items": [
      {
        "code": "happy",
        "emoji": "🙂",
        "url": "https://cdn/.../happy.gif",
        "fileSize": 18324,
        "checksum": "md5..."
      }
    ]
  }
  ```
  `xiaozhi-server` 仅负责将 manifest URL & version 推送给设备，无需逐一转发文件。
- **情绪映射更新**：将 `core/utils/textUtils.py` 中 `EMOJI_MAP` 抽象为可热更新，优先读取当前生效的 manifest；若 manifest 缺少 `code`，退回默认映射。
- **设备通信**：保持 WebSocket/MQTT 通道，在 `textUtils.get_emotion` 返回 `emotion` 时，增加 `assetVersion` 字段，便于设备检查资源是否存在。

## 设备端处理（ESP32）
- 接收到新的 `version` 后，若版本号不同：
  1. GET manifest，比较本地 `checksum`。
  2. 下载缺失资源到本地 Flash（建议目录 `/spiffs/emotions/`）。
  3. 更新本地 `emotion_index.json`，包含 `code → 文件路径`。
- 播放优先级：若存在自定义文件则播放动图；否则回退到默认 Emoji。
- 考虑 Flash 容量，提供“仅下载静态封面”配置（可由 manifest `animation: true/false` 标识）。

## 前端交互（manager-web-react）
- 角色详情页新增“表情包” tab：
  - 列表展示默认/自定义表情（缩略图、Emoji、上传状态）。
  - 支持替换、移除图片；GIF 自动展示封面帧。
  - 显示当前草稿是否与已发布版本一致，若有更改显示“待发布”。
- 操作按钮：`保存草稿`、`发布并下发`。
- 发布后提示用户下发对象（全部关联设备/选择设备），调用后端 publish 接口。

## 权限与审计
- 仅超级管理员和拥有角色编辑权限的用户可上传/发布表情。
- 所有发布操作记录在审计日志，包含 `agentId`、`version`、操作者、时间。

## 验证与运维
- **单元测试**：Manager API 增加对新增 Service/Controller 的测试；`xiaozhi-server` 增加 manifest 解析与回退逻辑测试。
- **联调测试**：准备一台测试设备，验证 GIF 帧率、下载失败回退逻辑。
- **监控**：记录 manifest 排布与资源下载失败次数，便于追踪网络或存储问题。

## 迭代计划
1. 数据库表与默认数据初始化；Manager API 上传/查询接口。
2. 前端角色表情管理 UI，实现草稿版保存。
3. 发布流程、版本管理与 manifest 生成。
4. 设备端固件升级，支持资源下载与缓存；灰度验证。
5. 正式上线后观察 1~2 周，汇总问题并安排后续优化（如批量导入、模板市场等）。
