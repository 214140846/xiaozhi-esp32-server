# 小智 IndexTTS 接入 功能与数据库字段清单（草案）

> 来源文件：
> - docs/dev/小智声音克隆IndexTTS接入/技术方案-Server端.md
> - docs/dev/小智声音克隆IndexTTS接入/技术方案-ManagerAPI端.md
> - docs/dev/小智声音克隆IndexTTS接入/技术方案总览 架构.md
>
> 说明：本清单聚合三份方案中的结论，按单人团队最小闭环输出。若与既有实现冲突，以实际代码和 Liquibase 变更为准；差异处以“可选”形式给出。

## 功能清单

- 实时引擎 Server
  - 以配置启用 Provider：`selected_module.TTS = IndexStreamTTS`，直连 IndexTTS 合成。
  - 运行时按角色查询 `voiceId` 与 `ttsModelId`，从管理接口获取映射，失败回退默认音色。
  - 流式播放与分片推流不变；合成失败三次退避并降级。
  - 指标与日志：成功率 首帧延迟 重试次数 合成时长 设备标识 文本长度 音色编号 错误摘要。
  - 用量统计：不新增上报通道，沿用聊天记录上报与聚合（最小方案）。

- 管理 API
  - 声音克隆：代理 IndexTTS `POST /voices/clone`，存储克隆音色元数据，可返回预览地址。
  - 音色位：支持管理员分配用户音色位（slot），每个音色位拥有独立克隆次数与当前绑定的 voiceId。
  - 音色管理：共享音色查询与分配；角色到音色映射读写。
  - 配额与用量：阈值配置与用量统计，提供扣减校验能力（可选两种落地方案见下）。
  - 合成测试：管理台同步合成测试，返回音频或链接，仅用于测试页。
  - 作为 Server 配置源：`POST /config/agent-models` 返回角色到 TTS 模型与音色映射。

- 管理前端 React
  - 服务端配置页：新增 IndexTTS 基础地址与密钥字段，仅管理员可见。
  - 声音克隆向导、我的音色、合成测试：最小可用闭环。
  - 音色分配与共享音色：按模型筛选与分配。

## 数据库与配置清单（最小推荐 + 可选）

说明：字段命名以数据库 snake_case 为主，Java DTO 采用 camelCase 对应。

### 复用表与字段（不新增）

- ai_agent（智能体）
  - tts_model_id varchar 更换模型时使用
  - tts_voice_id varchar 映射到 IndexTTS 或其他 Provider 的 voiceId

- ai_agent_template（智能体模板）
  - tts_model_id varchar 模板默认模型
  - tts_voice_id varchar 模板默认音色

- ai_tts_voice（共享音色库）
  - 以现有结构为准；业务相关键：
    - voice_id varchar 主键或唯一键 对应平台音色标识
    - tts_model_id varchar 归属的 Provider 模型
    - name 等展示字段按现有表使用

- sys_params（系统参数表）
  - 新增参数建议（仅管理员可写）：
    - param_code: `indextts.base_url` value_type: string 用于管理台合成与克隆适配器
    - param_code: `indextts.api_key` value_type: string 仅后端读取 前端不回显
  - 可选：`indextts.timeout_ms` `indextts.retry` 根据需要添加
  - 参数配置（前端）：在“系统参数”页面配置（接口前缀 `admin/params`，仅 `sys:role:superAdmin` 可写）
    - 新增/编辑：`POST /admin/params`、`PUT /admin/params`
    - 列表：`GET /admin/params/page`
    - UI 规范：`indextts.base_url` 明文显示；`indextts.api_key` 输入框遮挡，保存后不回显完整值，仅显示“已配置”。
    - 服务读取：`SysParamsService.getValue('indextts.base_url', true)` 与 `SysParamsService.getValue('indextts.api_key', true)`

- ai_agent_chat_history（聊天记录表）
  - 用量最小方案按该表聚合统计（字符数 调用次数 持续时长）。

### 新增表（最小必要）

- tts_slot（音色位 必要）
  - id bigint pk 自增（内部主键）
  - slot_id varchar 唯一（业务 ID，供前后端与克隆接口使用）
  - user_id bigint 索引（拥有者）
  - name varchar 可空（展示名）
  - tts_model_id varchar 可空（绑定模型，便于筛选）
  - voice_id varchar 可空（当前绑定音色，上游 voice_id）
  - preview_url varchar 可空（当前预听地址）
  - clone_limit int 默认值（此音色位可使用的克隆次数配额）
  - clone_used int 默认0（已使用次数）
  - status varchar 枚举 empty active disabled
  - last_cloned_at datetime 可空
  - created_at datetime
  - updated_at datetime
  - 约束：`uniq_slot_id`（slot_id 唯一），`idx_user_id`（user_id 索引）

- ai_tts_voice_clone（用户克隆音色 可选按需启用）
  - id bigint pk 自增
  - user_id bigint 索引
  - voice_id varchar 唯一 外部平台音色标识
  - name varchar 展示名称
  - status varchar 枚举 active disabled failed
  - preview_url varchar 预听地址 可为空
  - source varchar 记录来源 uploaded recorded 等
  - created_at datetime
  - updated_at datetime
  - 备注：若仅允许管理员克隆 也可复用 ai_tts_voice 增加来源字段 简化一张表

### 配额与用量 两种落地方案（二选一）

- 方案 A（推荐 最小改动）
  - 配额阈值：复用 `sys_params`
    - `tts.quota.char_limit.default` 字符总额 默认值
    - `tts.quota.call_limit.default` 调用总额 默认值
    - `tts.quota.switch` on off 开关
  - 用量统计：聚合 `ai_agent_chat_history` 派生指标
    - cost_chars = sum(text_len)
    - cost_calls = count(tts events)
    - duration_ms = sum(tts_duration)
  - 优点：零新表 维护成本低；缺点：无法细粒度审计每次扣减

- 方案 B（精细记账 需要两表）
  - tts_quota（用户配额阈值与已用）
    - id bigint pk 自增
    - user_id bigint 唯一索引
    - char_limit bigint 默认值或定制阈值
    - call_limit bigint 默认值或定制阈值
    - char_used bigint 累计已用
    - call_used bigint 累计已用
    - slots int 可用音色位数量（上限） 可为空（与 tts_slot 共用；真实音色位列表以 tts_slot 为准）
    - updated_at datetime
  - tts_usage（每次扣减流水）
    - id bigint pk 自增
    - user_id bigint 索引
    - agent_id bigint 可为空 用于角色归因
    - endpoint varchar 枚举 clone tts test
    - cost_chars int 本次计费字符数
    - cost_calls int 本次计费调用数 通常为 1
    - duration_ms int 合成时长 毫秒
    - created_at datetime
  - 接口配合：受理即预扣 失败回滚 成功写 usage 并累加 quota 已用

## 接口与字段映射（摘要）

- 声音克隆 `POST /ttsVoice/clone`
  - 入参：slotId fileUrls name?
  - 过程：
    - 校验 slotId 存在且未禁用；首次克隆将 slot 由 empty → active。
    - 调用 IndexTTS 克隆 返回 voiceId；写入/覆盖 tts_slot.voice_id、preview_url、last_cloned_at，并自增 clone_used；若达到 clone_limit 则提示但不强制禁止（按配置）。
  - 落库：`tts_slot.voice_id preview_url clone_used`（必要）+ 可选写 `ai_tts_voice_clone` 历史

- 共享音色查询 `GET /models/{modelId}/voices`
  - 来源：`ai_tts_voice` 过滤 `tts_model_id`

- 角色映射读写 `GET /agent/{id}` `PUT /agent/{id}`
  - 落库：`ai_agent.tts_model_id` `ai_agent.tts_voice_id`

- 引擎配置 `POST /config/agent-models`
  - 出参：roleId ttsModelId ttsVoiceId 仅读取映射 不切换 Provider

- 配额与用量（按所选方案）
  - 方案 A：`GET /api/tts/quotas` 从 `sys_params` 读取阈值；用量由聚合接口返回
  - 方案 B：`GET/POST /api/tts/quotas` 读写 `tts_quota`；`POST /api/tts/usage` 写入 `tts_usage`

- 合成测试 `POST /api/tts/speak`
  - 入参：text voiceId 可选 refAudioUrl
  - 记录：可选写 usage 或仅日志

- 密钥配置 `GET/POST /admin/config/indextts`
  - 落库：`sys_params.indextts.base_url` `sys_params.indextts.api_key`

## 迁移与种子数据（建议）

- Liquibase 问卷
  - 必选：新增 `tts_slot`（含唯一键与索引）
  - 是否采用方案 A：仅新增 `sys_params` 参数 和 可选 `ai_tts_voice_clone`
  - 或采用方案 B：新增 `tts_quota` 与 `tts_usage` 并建立必要索引（usage 建议记录 slotId）
- 建议索引
  - tts_slot：`uniq_slot_id`、`idx_user_id`、`idx_user_status`
  - ai_tts_voice_clone：`idx_user_id` `uniq_voice_id`
  - tts_quota：`uniq_user_id`
  - tts_usage：`idx_user_id_created_at` `idx_agent_id_created_at`
- 种子数据
  - `sys_params` 插入 `indextts.base_url` `indextts.api_key` 空安全值
  - `sys_params` 可选：`tts.slot.default_clone_limit`（默认每个音色位克隆次数）

## 验收口径（与方案对齐）

- 角色映射读取 正确返回 `tts_model_id tts_voice_id` 并被 Server 使用
- 克隆成功写入元数据 可见预听 共享音色可检索
- 配额阈值与用量 返回与选择的实现一致；超限返回统一错误码
- 指标与日志包含 requestId voiceId 文本长度 成功与耗时

---

备注：本清单控制在三百行内，命名与字段可由你在实现中调整。若需要，我可以补一份 Liquibase 草稿与 OpenAPI 字段示例。

## 需要实现的改动（结合现状对齐）

- 现有能力对齐（无需改动）
  - 角色字段已具备：`ai_agent.tts_model_id`、`ai_agent.tts_voice_id`，实体见 `main/manager-api/src/main/java/xiaozhi/modules/agent/entity/AgentEntity.java`。
  - 模板字段已具备：`ai_agent_template.tts_model_id`、`ai_agent_template.tts_voice_id`，见 `main/manager-api/src/main/java/xiaozhi/modules/agent/entity/AgentTemplateEntity.java`。
  - 共享音色查询已具备：`GET /models/{modelId}/voices`，见 `main/manager-api/src/main/java/xiaozhi/modules/model/controller/ModelController.java`。
  - 引擎配置接口已具备：`POST /config/server-base`、`POST /config/agent-models`，见 `main/manager-api/src/main/java/xiaozhi/modules/config/controller/ConfigController.java`；服务端调用位于 `main/xiaozhi-server/config/manage_api_client.py`。
  - 远端差异化注入 `private_voice` 已具备：见 `main/manager-api/src/main/java/xiaozhi/modules/config/service/impl/ConfigServiceImpl.java` 方法 `buildModuleConfig` 中 TTS 分支。

- 数据库变更（Liquibase）
  - 新增 `sys_params` 参数项（最小必要）
    - `indextts.base_url`、`indextts.api_key`（仅后端可读，不在接口回显）。
  - 新增（可选）`ai_tts_voice_clone`（若开放用户自助克隆）
    - 字段按本文件“新增表”小节执行；建立 `idx_user_id`、`uniq_voice_id` 索引。
  - 种子数据
    - `ai_model_config` 新增一条 IndexStreamTTS 模型配置（type: `index_stream`，含 `api_url` 等），以供 Agent/模板引用。

- Manager API 改动
  - 音色位管理（新增）
    - `POST /tts/slots/allocate`（管理员）入参：`userId, count?, cloneLimit?` 返回：`{ slots: [{ slotId, cloneLimit }] }`
    - `PUT /tts/slots/{slotId}`（管理员）入参：`status?|active/disabled, cloneLimit?, name?, ttsModelId?` 返回：`{ slotId }`
    - `GET /tts/slots`（管理员）查询：`userId? status?`；`GET /tts/slots/mine`（当前用户）
    - `GET /tts/slots/{slotId}` 返回 slot 当前状态（含 `voiceId previewUrl cloneUsed cloneLimit`）
  - 克隆接口（新增，路径建议复用音色域；与音色位联动）
    - `POST /ttsVoice/clone`（仅管理员或拥有克隆权限的用户）
    - 入参：`slotId`（必填）、`fileUrls[]`、`name?`
    - 行为：读取 `sys_params` 的 IndexTTS 基址与密钥，调用平台 `POST /voices/clone`，将结果覆盖写入 `tts_slot.voice_id preview_url last_cloned_at` 并 `clone_used = clone_used + files_accepted`；可选落表 `ai_tts_voice_clone` 做历史。
    - 位置建议：`main/manager-api/src/main/java/xiaozhi/modules/timbre/controller/TimbreCloneController.java` 与对应 `service/dao/entity`。
  - 合成测试（新增，管理台专用）
    - `POST /tts/test/speak` 返回 `audio/wav` 或下载地址；根据所选模型配置动态决定请求参数名（`voice_id` 或 `character`）。
    - 位置建议：`modules/timbre` 新增 `TTSTestController`，服务封装 `IndexTtsClient`（读取 `sys_params`）。
  - 配额与用量（按最终共识采用方案 A）
    - 阈值：复用 `sys_params`，新增只读接口 `GET /tts/quotas` 汇总返回阈值与当期用量；用量聚合自 `ai_agent_chat_history`（已有 `POST /agent/chat-history/report` 上报）。
    - 若后续需要精细记账，再落地 `tts_quota/tts_usage`，此版本不实现。
  - Swagger 暴露路径
    - 现有已包含：`/models/**`、`/ttsVoice/**`、`/config/**`。
    - 如新增 `/tts/**`，需在 `main/manager-api/src/main/java/xiaozhi/common/config/SwaggerConfig.java` 追加 `pathsToMatch("/tts/**")`。

- Server 改动
  - 代码层面零改动：`IndexStreamTTS` Provider 已就绪，语音参数通过 `private_voice` 注入已支持。
  - 配置层面两种方式择一：
    - 本地：在 `main/xiaozhi-server/config.yaml` 或 `data/.config.yaml` 设置 `selected_module.TTS: IndexStreamTTS` 与 `TTS.IndexStreamTTS.api_url`、`voice`。
    - 远端：在管理端为 Agent/模板设置 `tts_model_id` 指向 IndexStreamTTS 的模型配置，并在音色处选择对应 `ai_tts_voice`/克隆音色；Server 启动后走 `POST /config/server-base` + `POST /config/agent-models` 获取配置。

- 前端改动（最小）
  - 平台密钥配置：沿用系统“参数配置”页，新增 `indextts.base_url`、`indextts.api_key` 表单项（仅超级管理员可写）。
    - 保存时调用：`POST /admin/params` 或 `PUT /admin/params`，字段：`{ paramCode, paramValue, valueType: 'string', remark }`
    - 展示：`indextts.api_key` 不回显明文，仅显示已设置状态。
  - 音色位：新增“音色位管理”页（管理员：分配/禁用/设限；用户：查看剩余次数）。
  - 声音克隆向导：从“我的音色位”中选择一个 `slotId` 后调用 `POST /ttsVoice/clone`；“我的音色”页可选展示历史 `ai_tts_voice_clone`。
  - 合成测试：调用 `POST /tts/test/speak` 并播放音频。

- 兼容与回滚
  - 未启用 IndexStreamTTS 时，系统行为不变；回滚仅需把 Agent/模板的 `tts_model_id` 切回原模型，或本地 `selected_module.TTS` 切回。
- 出现平台故障时，Server 端可退回默认音色（已在 Provider 兜底策略中体现）。

## 验收建议用例（落地检查）

- 角色映射：Agent 设置 `tts_model_id` 指向 IndexStreamTTS，`tts_voice_id` 指向有效音色；Server 拉取后可合成播放。
- 克隆流程：管理员分配 1 个音色位；用户选择该 `slotId` 上传 2 段音频完成克隆，返回 `voiceId`，slot 变更为 active 且可预听；再次对同一 `slotId` 克隆，应覆盖 slot.voice_id 并自增 clone_used。
- 合成测试：管理台输入 100 中文字符内文本，首帧 < 2s，成功率 ≥ 95%。
- 配额与用量：`GET /tts/quotas` 能返回阈值与按聊天记录聚合的统计；超限时返回统一错误码与提示。

## 接口字段统一（基于 api.md 与现有实现）

- 上游 IndexTTS 合同（保持不变）
  - 克隆：`POST /voices/clone`
    - Req JSON：`{ upload_urls: string[] }`
    - Resp JSON：`{ voice_id: string, files_accepted: number, files_skipped: number, preview_url?: string }`
  - 合成：`POST /tts`
    - Req JSON：`{ text: string, voice_id: string }`
    - Resp：`audio/wav`

- 管理 API 对前端（统一字段与映射）
  - 共享音色列表：`GET /models/{modelId}/voices`
    - Resp 列表项字段（来源 `TimbreDetailsVO`）：
      - `id`（ai_tts_voice.id）
      - `ttsModelId`（模型 ID，用于识别 Provider）
      - `name`、`languages`、`voiceDemo`、`ttsVoice`（ttsVoice 即上游 voice_id/character）
  - 声音克隆（新）：`POST /ttsVoice/clone`
    - Req JSON：`{ slotId: string, fileUrls: string[], name?: string }`
    - 字段映射：`fileUrls` → 上游 `upload_urls`
    - Resp JSON：`{ voiceId: string, filesAccepted: number, filesSkipped: number, previewUrl?: string, slotId: string, cloneUsed: number, cloneLimit?: number }`
      - 字段映射：`voiceId` ← 上游 `voice_id`；`filesAccepted` ← `files_accepted`；`filesSkipped` ← `files_skipped`；`previewUrl` ← `preview_url`
  - 合成测试（新）：`POST /tts/test/speak`
    - Header：后端鉴权（平台内部接口），无需透出上游密钥
    - Req JSON：`{ text: string, ttsVoiceId: string, ttsModelId?: string }`
      - 说明：`ttsVoiceId` 为 `ai_tts_voice.id`；后端查询 `ttsVoice` 并转为上游 `voice_id`
    - Resp：`audio/wav`
  - 配额与用量（最小方案 A）：
    - 配额阈值：`GET /tts/quotas` → 从 `sys_params` 汇总返回 `{ charLimit, callLimit, switch }`
    - 用量：从 `ai_agent_chat_history` 聚合返回 `{ costChars, costCalls, durationMs, window }`

- 管理 API 对 Server（保持现状）
  - `POST /config/server-base`：不变
  - `POST /config/agent-models`：不变；当选择 IndexStreamTTS 时，TTS 模型配置注入 `private_voice = <timbre.ttsVoice>`

- 字段命名规范与大小写
  - 对前端返回统一 camelCase：`voiceId`、`filesAccepted`、`previewUrl`
  - 向上游 IndexTTS 转发统一 snake_case：`upload_urls`、`voice_id`
  - 数据库存储按照现有表：`ai_tts_voice.tts_voice` 持久化上游 `voice_id`

## CustomTTS → IndexTTS 替换思路（含音色位与计费）

- 识别现状（Server 本地配置）
  - `config.yaml` 中存在 `TTS.CustomTTS`（type: custom，params.voice 等），或远端默认 TTS 指向自定义服务。
- 替换步骤（最小改造）
  1 配置平台参数：在“系统参数”页设置 `indextts.base_url`、`indextts.api_key`。
  2 新增模型：在“模型配置”新增 `IndexStreamTTS`（type=index_stream，api_url 指向 `/tts`）。
  3 分配音色位并克隆：管理员为用户创建 `slotId`，用户调用 `POST /ttsVoice/clone` 完成首克隆，落库 `tts_slot.voice_id`；同时镜像/更新一条 `ai_tts_voice` 记录（id 建议使用 `slot:<slotId>`，`tts_voice = voice_id`）。
  4 角色映射：将 `Agent.tts_model_id` 指向 `IndexStreamTTS`，将 `Agent.tts_voice_id` 指向镜像后的 `ai_tts_voice.id`（即 `slot:<slotId>`）。
  5 Server 切换 Provider：本地 `.config.yaml` 或远端配置的 `selected_module.TTS` 切换为 `IndexStreamTTS`（私有音色将通过远端 `private_voice` 注入为 slot 对应的 `tts_voice`）。
  6 计费联动：
    - 克隆：按 `files_accepted` 递增 `tts_slot.clone_used`；超过 `clone_limit` 返回 402（可配置是否强制限制）。
    - 合成：沿用 `ai_agent_chat_history` 聚合统计调用数/字符数（方案 A），无需改 Server 代码；远端模式自动启用 TTS 上报。
  7 回滚兼容：保留原 `TTS.CustomTTS` 配置；如需回滚仅将 `selected_module.TTS` 改回原 Provider。
