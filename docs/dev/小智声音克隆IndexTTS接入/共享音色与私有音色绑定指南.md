# 共享音色与私有音色 绑定指南（一页式）

一页式速查
- 管理员上架共享音色：POST `/xiaozhi/ttsVoice` → 任何用户可见
- 用户克隆私有音色：POST `/xiaozhi/ttsVoice/clone` → 得到 `slotId`
- 用户给音色位设置模型：PUT `/xiaozhi/tts/slots/{slotId}/model` → 镜像到 `ai_tts_voice`（主键=`slotId`）
- 绑定到角色：PUT `/xiaozhi/agent/{agentId}`，`ttsModelId=…`，`ttsVoiceId={slotId}`（或共享音色ID）
- 合成校验：POST `/xiaozhi/tts/synthesize`（`ttsVoiceId` 或 `slotId` 二选一）

Swagger 定位（doc.html 搜索）
- 音色管理：`/ttsVoice`（管理员）
- 音色位-用户：`/tts/slots/*`（普通用户）
- 智能体管理：`/agent/{id}`（普通用户）

权限约定
- 管理员：`sys:role:superAdmin`
- 普通用户：`sys:role:normal`

目标
- 管理员创建共享音色 供所有用户按模型选择
- 普通用户自助克隆私有音色 并绑定到自己的角色

前置
- 已存在一个启用的 TTS 模型 示例 TTS_IndexStreamTTS 或具体模型 id
- 上游 IndexTTS 已可用 管理端已配置 indextts.base_url 与 indextts.api_key

---

## 管理员创建共享音色（所有人可见）

用途
- 把上游 voice_id 上架为平台共享音色 任何用户都能在该模型下拉中看到

接口
- 新增共享音色 `POST /ttsVoice`
- 修改共享音色 `PUT /ttsVoice/{id}`
- 删除共享音色 `POST /ttsVoice/delete`
- 按模型查询音色 `GET /models/{modelId}/voices`

新增示例（共享音色）
```
POST {BASE}/xiaozhi/ttsVoice
Authorization: Bearer <管理员令牌>
Content-Type: application/json

{
  "ttsModelId": "TTS_IndexStreamTTS",     
  "ttsVoice": "c964dfb5-xxxx-xxxx-xxxx", 
  "name": "示例共享音色",
  "languages": "中文",
  "voiceDemo": "https://example.com/demo.mp3",
  "remark": "共享音色上架",
  "sort": 0
}
```

校验
```
GET {BASE}/xiaozhi/models/TTS_IndexStreamTTS/voices
```
列表应包含刚上架的条目 其 id 为共享音色表主键 可用于绑定到角色的 ttsVoiceId

绑定到角色
```
PUT {BASE}/xiaozhi/agent/{agentId}
Authorization: Bearer <用户令牌>
Content-Type: application/json

{
  "ttsModelId": "TTS_IndexStreamTTS",
  "ttsVoiceId": "<ai_tts_voice.id>"
}
```

运行时验证 设备应在 `POST /config/agent-models` 的 TTS 配置内看到 `private_voice` 为上游 voice_id

---

## 普通用户克隆并绑定“仅自己可用”的私有音色

用途
- 用户上传参考音频 同步克隆 voice_id 并绑定到自己的角色

步骤一 克隆音色位
```
POST {BASE}/xiaozhi/ttsVoice/clone
Authorization: Bearer <用户令牌>
Content-Type: application/json

{
  "fileUrls": ["https://download.samplelib.com/wav/sample-15s.wav"],
  "name": "我的音色"
}
```
返回包含 `slotId` 与 `voiceId`

步骤二 绑定模型并触发镜像
```
PUT {BASE}/xiaozhi/tts/slots/{slotId}/model
Authorization: Bearer <用户令牌>
Content-Type: application/json

{
  "ttsModelId": "TTS_IndexStreamTTS",
  "name": "我的音色 上架"
}
```
成功后系统会将当前 `slot.voiceId` 镜像为共享音色（仅你可绑定，别人列表不会显示）：
- 写入 `ai_tts_voice` 一条记录，主键=`{slotId}`（避免主键过长）
- 归属 `ttsModelId`

步骤三 绑定到我的角色
```
PUT {BASE}/xiaozhi/agent/{agentId}
Authorization: Bearer <用户令牌>
Content-Type: application/json

{
  "ttsModelId": "TTS_IndexStreamTTS",
  "ttsVoiceId": "{slotId}"   // 直接用 slotId 绑定私有音色
}
```

快速验证
- 我的音色位：`GET {BASE}/xiaozhi/tts/slots/{slotId}` 应显示 `ttsModelId/voiceId`
- 共享列表不显示你的私有音色：`GET {BASE}/xiaozhi/models/TTS_IndexStreamTTS/voices` 默认已隐藏来自 tts_slot 的镜像
- 不改角色也可测试合成
```
POST {BASE}/xiaozhi/tts/synthesize
Authorization: Bearer <用户令牌>
Content-Type: application/json

{ "text": "你好 这是一次合成", "ttsVoiceId": "{slotId}" }
```

---

注意
- 绑定到角色时 `ttsVoiceId` 必须使用平台音色表的主键 即共享音色 id（此处为 `{slotId}`） 不是上游 voice_id
- 先克隆后绑定 或先绑定后克隆都可以 若绑定时 slot 已有 voiceId 会立即镜像 若暂时没有 下次克隆成功后自动镜像
- 运行时服务需要与管理端一致的 TTS 模型配置 确保该模型 `configJson` 中含有 api_url 与 api_key 

---

常见问题（Troubleshooting）
- 看不到绑定接口：后端重启后，doc.html 搜索“音色位-用户”，路径需带前缀 `/xiaozhi`
- 403 Not authenticated：把 IndexTTS 的 key 写入 TTS 模型的 `configJson.api_key`（不是 sys_params），并确保走 `Authorization: Bearer <key>` 或按需配置 `auth_header/api_key_prefix`
- 绑定失败 tts_voice_id 太长：后端已将 `ai_agent.tts_voice_id` 扩容到 `VARCHAR(128)`；若你自管 DB，请执行变更
- 列表里看不到我的克隆音色：属于私有音色，已默认对其他用户隐藏；你直接用 `ttsVoiceId={slotId}` 绑定即可
