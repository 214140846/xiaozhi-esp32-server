# 小智 IndexTTS 数据实体关系图（Mermaid）

> 说明：本图覆盖复用表与新增表，并标注主要外键与权限。节点与关系名使用安全文本。

```mermaid
%% 实体与关系图（可渲染）
erDiagram
    SYS_PARAMS {
        string param_code PK
        string param_value
        string value_type
        int param_type
        string remark
        datetime update_date
    }

    AI_MODEL_CONFIG {
        string id PK
        string model_type
        string provide_code
        boolean is_enabled
        boolean is_default
        json config_json
    }

    AI_TTS_VOICE {
        string id PK
        string tts_model_id FK
        string tts_voice
        string name
        string languages
        string voice_demo
    }

    AI_AGENT_TEMPLATE {
        string id PK
        string tts_model_id FK
        string tts_voice_id FK
    }

    AI_AGENT {
        string id PK
        long user_id
        string tts_model_id FK
        string tts_voice_id FK
    }

    TTS_SLOT {
        long id PK
        string slot_id UK
        long user_id FK
        string tts_model_id FK
        string voice_id
        string preview_url
        int clone_limit
        int clone_used
        string status
        datetime last_cloned_at
        datetime created_at
        datetime updated_at
    }

    AI_TTS_VOICE_CLONE {
        long id PK
        long user_id FK
        string slot_id FK
        string voice_id
        string name
        string status
        string preview_url
        string source
        datetime created_at
        datetime updated_at
    }

    TTS_QUOTA {
        long id PK
        long user_id UK
        long char_limit
        long call_limit
        long char_used
        long call_used
        int slots
        datetime updated_at
    }

    TTS_USAGE {
        long id PK
        long user_id FK
        string agent_id FK
        string endpoint
        int cost_chars
        int cost_calls
        int duration_ms
        string slot_id FK
        datetime created_at
    }

    SYS_USER {
        long id PK
        string username
    }

    %% 关系
    AI_MODEL_CONFIG ||--o{ AI_TTS_VOICE : has
    AI_MODEL_CONFIG ||--o{ AI_AGENT_TEMPLATE : used_by
    AI_MODEL_CONFIG ||--o{ AI_AGENT : used_by
    AI_MODEL_CONFIG ||--o{ TTS_SLOT : used_by

    AI_TTS_VOICE ||--o{ AI_AGENT_TEMPLATE : default_for
    AI_TTS_VOICE ||--o{ AI_AGENT : mapped_to

    SYS_USER ||--o{ TTS_SLOT : owns
    SYS_USER ||--o{ AI_TTS_VOICE_CLONE : creates
    SYS_USER ||--o{ TTS_QUOTA : has
    SYS_USER ||--o{ TTS_USAGE : uses

    TTS_SLOT ||--o{ AI_TTS_VOICE_CLONE : history
    TTS_SLOT ||--o{ TTS_USAGE : logs

    AI_AGENT ||--o{ TTS_USAGE : logs
```

- 权限与使用
  - 共享音色 AI_TTS_VOICE：仅管理员可新增编辑删除；全体可读使用（按模型筛选）。
  - 音色位 TTS_SLOT：管理员分配给用户；用户基于 slot 克隆与替换绑定 voice_id。
  - 克隆历史 AI_TTS_VOICE_CLONE：记录每次克隆结果与预览，便于审计与回溯。
  - 配额与用量 TTS_QUOTA 与 TTS_USAGE：采用两表方案；合成与克隆写入 usage，对账聚合于看板。
  - 平台参数 SYS_PARAMS：配置 indextts.base_url 与 indextts.api_key，仅管理员可写。

